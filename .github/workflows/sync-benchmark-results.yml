name: Sync Benchmark Results from sagellm-benchmark

# âš ï¸ å¦‚æœ sagellm-benchmark æ˜¯ç§æœ‰ä»“åº“ï¼Œéœ€è¦é…ç½® PAT_TOKEN:
# 1. åˆ›å»º PAT: GitHub Settings â†’ Developer settings â†’ Personal access tokens
# 2. æƒé™: repo (Full control)
# 3. æ·»åŠ åˆ°æœ¬ä»“åº“ Secrets: Settings â†’ Secrets â†’ Actions â†’ New secret
#    Name: PAT_TOKEN
#    Value: <your-token>
#

on:
  # ä¸»è¦åŒæ­¥æ–¹å¼ï¼šå½“ benchmark ä»“åº“ main/main-dev æœ‰æ–°æäº¤æ—¶è‡ªåŠ¨è§¦å‘
  repository_dispatch:
    types: [benchmark-updated]
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•æˆ–ç´§æ€¥åŒæ­¥ï¼‰
  workflow_dispatch:
  
  # å®šæœŸå¤‡ä»½åŒæ­¥ï¼ˆæ¯å¤© UTC 00:00ï¼ŒåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'

jobs:
  sync-results:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout website repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout benchmark repository
        uses: actions/checkout@v4
        with:
          repository: intellistream/sagellm-benchmark
          path: benchmark
          # ä½¿ç”¨è§¦å‘äº‹ä»¶ä¼ é€’çš„åˆ†æ”¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ main-dev
          ref: ${{ github.event.client_payload.ref || 'main-dev' }}
          token: ${{ secrets.PAT_TOKEN }}  # è®¿é—®ç§æœ‰ä»“åº“éœ€è¦ PAT
      
      - name: Find and copy leaderboard files
        id: copy-files
        run: |
          echo "Finding leaderboard files in benchmark repository..."
          
          # Find all leaderboard files
          leaderboard_files=$(find benchmark/outputs/ -name "*_leaderboard.json" -type f 2>/dev/null || true)
          
          if [ -z "$leaderboard_files" ]; then
            echo "No leaderboard files found"
            echo "files_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "files_found=true" >> $GITHUB_OUTPUT
          
          # Create results directory
          mkdir -p data/results
          
          # Copy files
          copied_count=0
          echo "$leaderboard_files" | while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              # Extract backend/model/run_id from path
              # benchmark/outputs/cpu/gpt2/short_20260128_005/short_input_leaderboard.json
              backend=$(echo "$file" | cut -d'/' -f3)
              model=$(echo "$file" | cut -d'/' -f4)
              run_id=$(echo "$file" | cut -d'/' -f5)
              filename=$(basename "$file")
              
              # Create destination directory
              dest_dir="data/results/${backend}/${model}"
              mkdir -p "$dest_dir"
              
              # Copy file with run_id prefix
              dest_file="$dest_dir/${run_id}_${filename}"
              cp "$file" "$dest_file"
              
              echo "âœ“ Copied: $file"
              echo "  â†’ $dest_file"
              
              copied_count=$((copied_count + 1))
            fi
          done
          
          # Count total files
          total=$(find data/results/ -name "*_leaderboard.json" -type f | wc -l)
          echo "files_count=$total" >> $GITHUB_OUTPUT
          echo "Total leaderboard files: $total"
      
      - name: Check for changes
        id: check-changes
        run: |
          if [ "${{ steps.copy-files.outputs.files_found }}" != "true" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git add data/results/
          
          if git diff --staged --quiet; then
            echo "No new changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat --staged
          fi
      
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: sync benchmark results from sagellm-benchmark
            
            Auto-sync from intellistream/sagellm-benchmark@main-dev
            Total files: ${{ steps.copy-files.outputs.files_count }}
          branch: sync-benchmark-results-${{ github.run_number }}
          delete-branch: true
          title: "[Auto] Sync Benchmark Results"
          body: |
            ## ğŸ¤– Automated Benchmark Results Sync
            
            This PR automatically syncs benchmark results from `sagellm-benchmark` repository.
            
            **Source:**
            - Repository: `intellistream/sagellm-benchmark`
            - Branch: `main-dev`
            - Sync Time: ${{ github.event.repository.updated_at }}
            
            **Changes:**
            - Total leaderboard files: ${{ steps.copy-files.outputs.files_count }}
            - Destination: `data/results/<backend>/<model>/`
            
            **Action Required:**
            - âœ… Review the benchmark results
            - âœ… Merge if results look correct
            - âŒ Close if results are invalid or outdated
            
            ---
            
            *This PR was automatically created by GitHub Actions.*
            *Workflow: `.github/workflows/sync-benchmark-results.yml`*
          labels: |
            automated
            benchmark-sync
            data-update
          draft: false
      
      - name: Summary
        if: always()
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.copy-files.outputs.files_found }}" != "true" ]; then
            echo "âŒ No leaderboard files found in benchmark repository" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-changes.outputs.has_changes }}" != "true" ]; then
            echo "âœ… No new changes - data is up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Created PR with ${{ steps.copy-files.outputs.files_count }} leaderboard files" >> $GITHUB_STEP_SUMMARY
          fi
